<%- include('partials/header') %>
<body>
  <%- include('partials/navbar') %>

  <main class="main" role="main">
    <div class="container" style="max-width: 760px;">
      <div class="card" style="margin: 3rem auto; padding: 2.5rem; border-radius: 14px; box-shadow: 0 12px 30px rgba(0,0,0,0.08);">
        <div style="text-align: center;">
          <div aria-hidden="true" style="font-size: 3.5rem;">üõ†Ô∏è</div>
          <h1 style="margin-top: 1rem; color: var(--text-primary); font-weight: 700;">Estamos fazendo um pit stop</h1>
          <p style="margin: 0.75rem auto 1.5rem; color: var(--text-secondary); max-width: 520px;">
            Nosso sistema est√° passando por uma instabilidade. J√° estamos cuidando disso para voc√™.
            Voc√™ pode tentar novamente em instantes ou nos avisar para acelerar a corre√ß√£o.
          </p>

          <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.25rem;">
            <button id="report-btn" class="btn btn-primary btn-lg" type="button">Reportar problema</button>
            <a href="/" class="btn btn-outline btn-lg">Tentar novamente</a>
          </div>

          <p id="report-feedback" style="color: var(--text-secondary); min-height: 1.25rem;">
            <% if (errorCode) { %>
              C√≥digo de refer√™ncia: <%= errorCode %>.
            <% } %>
          </p>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const btn = document.getElementById('report-btn');
      const feedback = document.getElementById('report-feedback');
      const errorCode = "<%= errorCode || '' %>";
      const autoKey = `autoIncident:${errorCode || 'no-code'}`;
      if (!btn) return;

      function setStatus(message, variant) {
        if (!feedback) return;
        const colors = {
          success: 'var(--success, #0f9d58)',
          error: 'var(--danger, #c0392b)',
          warning: 'var(--warning, #f39c12)',
          info: 'var(--text-secondary)'
        };
        feedback.style.color = colors[variant] || colors.info;
        feedback.textContent = message;
      }

      btn.addEventListener('click', async () => {
        btn.disabled = true;
        setStatus('Enviando seu relato...', 'info');

        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 8000);
          const res = await fetch('/api/report-incident', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              url: window.location.href,
              errorCode: "<%= errorCode || '' %>",
              userAgent: navigator.userAgent
            }),
            signal: controller.signal,
          });
          clearTimeout(timeout);

          const data = await res.json().catch(() => ({}));
          if (res.ok && data?.success) {
            setStatus(data.message || 'Obrigado! Registramos seu relato.', 'success');
          } else if (res.status === 429) {
            setStatus(data?.message || 'Limite de relatos atingido. Tente novamente mais tarde.', 'warning');
          } else {
            setStatus(data?.message || 'N√£o foi poss√≠vel registrar agora. Tente novamente.', 'error');
          }
        } catch (err) {
          const aborted = err?.name === 'AbortError';
          setStatus(aborted ? 'Demorou demais. Tente de novo em alguns segundos.' : 'Falha ao enviar. Verifique sua conex√£o e tente novamente.', 'error');
        } finally {
          btn.disabled = false;
        }
      });

      // Autodisparo (LAN) para n√£o depender do clique manual
      async function autoReportOnce() {
        if (sessionStorage.getItem(autoKey)) return;
        sessionStorage.setItem(autoKey, '1');
        if (feedback) setStatus('Registrando diagn√≥stico autom√°tico...', 'info');
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 8000);
          const res = await fetch('/api/report-incident', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              url: window.location.href,
              errorCode,
              auto: true,
              userAgent: navigator.userAgent
            }),
            signal: controller.signal,
          });
          clearTimeout(timeout);
          const data = await res.json().catch(() => ({}));
          if (res.ok && data?.success) {
            setStatus(data.message || 'Diagn√≥stico autom√°tico disparado.', 'success');
          } else {
            setStatus(data?.message || 'N√£o foi poss√≠vel registrar automaticamente.', 'warning');
          }
        } catch (err) {
          const aborted = err?.name === 'AbortError';
          setStatus(aborted ? 'Diagn√≥stico autom√°tico demorou; tente o bot√£o.' : 'Falha no diagn√≥stico autom√°tico.', 'error');
        }
      }

      // Pequeno atraso para evitar conflito com carregamento
      setTimeout(autoReportOnce, 600);
    })();
  </script>

  <%- include('partials/footer') %>
