<%- include('partials/header') %>
<body>
  <%- include('partials/navbar') %>

  <main class="main" role="main">
    <div class="container">
      <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
        <meta name="csrf-token" content="<%= csrfToken %>">
      <% } %>
      <div
        class="card"
        id="detalhesRecado"
        data-id="<%= id %>"
        data-can-update="<%= permissions && permissions.updateMessages ? 'true' : 'false' %>"
        data-can-edit-own="<%= userRoleSlug === 'operator' ? 'true' : 'false' %>"
        data-user-role="<%= userRoleSlug || 'reader' %>"
        data-user-id="<%= user ? user.id : '' %>"
        data-can-delete="<%= permissions && permissions.deleteMessages ? 'true' : 'false' %>"
      >
        <div class="card-header">
          <h2 class="card-title">Detalhes do Recado</h2>
        </div>
        <div class="card-body">
          <div class="tab-container" data-tabs>
            <div class="tab-nav" role="tablist">
              <button type="button" class="tab-button active" data-tab-button="details" aria-controls="tab-details">Detalhes</button>
              <button type="button" class="tab-button" data-tab-button="checklists" aria-controls="tab-checklists">Checklists</button>
              <button type="button" class="tab-button" data-tab-button="comments" aria-controls="tab-comments">Coment√°rios</button>
              <button type="button" class="tab-button" data-tab-button="watchers" aria-controls="tab-watchers">Seguidores</button>
              <button type="button" class="tab-button" data-tab-button="history" aria-controls="tab-history">Hist√≥rico</button>
            </div>
            <div class="tab-content">
              <section id="tab-details" class="tab-panel active" data-tab-section="details">
                <div data-details class="message-details mb-3">
                  <p class="text-muted">Carregando detalhes...</p>
                </div>
                <%- include('partials/recados/labels-badges', { permissions }) %>
              </section>
              <section id="tab-checklists" class="tab-panel" data-tab-section="checklists" hidden>
                <%- include('partials/recados/checklists', { permissions }) %>
              </section>
              <section id="tab-comments" class="tab-panel" data-tab-section="comments" hidden>
                <%- include('partials/recados/comments-thread', { permissions }) %>
              </section>
              <section id="tab-watchers" class="tab-panel" data-tab-section="watchers" hidden>
                <%- include('partials/recados/watchers', { permissions, activeUsers }) %>
              </section>
              <section id="tab-history" class="tab-panel" data-tab-section="history" hidden>
                <div data-history-empty class="text-muted">Sem eventos registrados.</div>
                <div data-history class="timeline"></div>
              </section>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div style="display:flex;gap:1rem;flex-wrap:wrap;">
            <a href="/recados" class="btn btn-outline" data-back-button>Voltar</a>
            <a href="/editar-recado/<%= id %>" class="btn btn-primary" data-edit-button hidden>‚úèÔ∏è Editar</a>
            <button type="button" class="btn btn-secondary" data-forward-button hidden>üì§ Encaminhar</button>
            <button type="button" class="btn btn-progress" data-progress-button hidden>üöß Em andamento</button>
            <button type="button" class="btn btn-success" data-resolve-button hidden>‚úÖ Resolver</button>
            <% if (permissions && permissions.deleteMessages) { %>
              <button type="button" class="btn btn-error" data-delete-button>üóëÔ∏è Excluir</button>
            <% } %>
          </div>
        </div>
      </div>
      <% if (permissions && permissions.updateMessages) { 
           const forwardUsers = Array.isArray(activeUsers) ? activeUsers : [];
           const forwardSectors = Array.isArray(activeSectors) ? activeSectors : [];
      %>
        <div class="modal fade" id="forwardModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
          <div class="modal-dialog">
            <form class="modal-content" id="forwardForm">
              <div class="modal-header">
                <h5 class="modal-title">Encaminhar recado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="forwardRecipientType" class="form-label">Tipo de destinat√°rio</label>
                  <select id="forwardRecipientType" name="recipientType" class="form-select" autocomplete="off">
                    <option value="user" selected>Usu√°rio espec√≠fico</option>
                    <option value="sector" <%= forwardSectors.length ? '' : 'disabled' %>>Setor</option>
                  </select>
                  <div class="form-help">Escolha se o recado ser√° encaminhado para um usu√°rio ou setor.</div>
                </div>
                <div class="mb-3" id="forwardUserGroup">
                  <label for="forwardRecipientUserId" class="form-label required">Usu√°rio destinat√°rio</label>
                  <select id="forwardRecipientUserId" name="recipientUserId" class="form-select" autocomplete="organization">
                    <option value="">Selecione um usu√°rio</option>
                    <% forwardUsers.forEach(function(user) { %>
                      <option value="<%= user.id %>"><%= user.name %></option>
                    <% }); %>
                  </select>
                  <div class="form-help">O usu√°rio selecionado receber√° um e-mail informando o encaminhamento.</div>
                </div>
                <div class="mb-3 d-none" id="forwardSectorGroup">
                  <label for="forwardRecipientSectorId" class="form-label required">Setor destinat√°rio</label>
                  <select id="forwardRecipientSectorId" name="recipientSectorId" class="form-select" autocomplete="organization">
                    <option value="">Selecione um setor</option>
                    <% forwardSectors.forEach(function(sector) { %>
                      <option value="<%= sector.id %>"><%= sector.name %></option>
                    <% }); %>
                  </select>
                  <div class="form-help">Todos os integrantes do setor poder√£o visualizar o recado.</div>
                </div>
                <div class="mb-3">
                  <label for="forwardNote" class="form-label">Observa√ß√£o para o destinat√°rio (opcional)</label>
                  <textarea id="forwardNote" name="forwardNote" class="form-textarea" rows="3" placeholder="Mensagem adicional para o novo destinat√°rio."></textarea>
                  <div class="form-help">A observa√ß√£o ser√° exibida no e-mail de encaminhamento.</div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="forwardSubmit">üì§ Encaminhar</button>
              </div>
            </form>
          </div>
        </div>
      <% } %>
    </div>
  </main>

  <%- include('partials/footer', { scripts: ['/js/visualizar-recado.js'] }) %>
