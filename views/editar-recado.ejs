<%- include('partials/header') %>
<body>
  <%- include('partials/navbar') %>

  <main class="main" role="main">
    <div class="container">
      <% if (typeof csrfToken !== 'undefined') { %>
        <meta name="csrf-token" content="<%= csrfToken %>">
      <% } %>
      <div style="margin-bottom:2rem;">
        <h1 style="font-size:2rem;font-weight:700;margin-bottom:0.5rem;">Editar Registro</h1>
        <p style="color:var(--text-secondary);">Atualize as informa√ß√µes do registro</p>
      </div>
      <div style="max-width:800px;">
        <form id="formEditarRecado" class="card" data-id="<%= id %>" data-related-messages data-contact-history-base="/contatos">
          <div class="card-header">
            <h2 class="card-title">Informa√ß√µes do Registro</h2>
            <p class="card-subtitle">Edite os campos necess√°rios</p>
          </div>
          <div class="card-body">
            <fieldset style="border: 1px solid var(--border-light); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 2rem;">
              <legend style="padding: 0 0.5rem; font-weight: 600; color: var(--text-primary);">üìû Dados da Liga√ß√£o</legend>
              <div class="form-grid-2">
                <div class="form-group">
                  <label for="call_date" class="form-label required">Data da Liga√ß√£o</label>
                  <input id="call_date" name="call_date" type="date" class="form-input" required data-label="Data da liga√ß√£o" autocomplete="bday" />
                </div>
                <div class="form-group">
                  <label for="call_time" class="form-label required">Hora da Liga√ß√£o</label>
                  <input id="call_time" name="call_time" type="time" class="form-input" required data-label="Hora da liga√ß√£o" autocomplete="off" />
                </div>
              </div>
              <input type="hidden" id="recipient" name="recipient" />

              <div class="form-group">
                <label for="recipientType" class="form-label required">Tipo de destinat√°rio</label>
                <select id="recipientType" name="recipientType" class="form-select" data-label="Tipo de destinat√°rio" autocomplete="off">
                  <option value="user" selected>Usu√°rio espec√≠fico</option>
                  <option value="sector">Setor</option>
                </select>
                <div class="form-help">Defina se este registro pertence a um usu√°rio ou a um setor.</div>
              </div>

              <div class="form-group" id="recipientUserGroup">
                <label for="recipientUserId" class="form-label required">Usu√°rio destinat√°rio</label>
                <select id="recipientUserId" name="recipientUserId" class="form-select" data-label="Usu√°rio destinat√°rio" autocomplete="organization" required>
                  <option value="">Selecione um usu√°rio</option>
                  <% (activeUsers || []).forEach(function(user) { %>
                    <option value="<%= user.id %>"><%= user.name %></option>
                  <% }); %>
                </select>
                <div class="form-help">Pessoa que deve receber e acompanhar este registro.</div>
              </div>

              <div class="form-group d-none" id="recipientSectorGroup">
                <label for="recipientSectorId" class="form-label required">Setor destinat√°rio</label>
                <select id="recipientSectorId" name="recipientSectorId" class="form-select" data-label="Setor destinat√°rio" autocomplete="organization">
                  <option value="">Selecione um setor</option>
                  <% (activeSectors || []).forEach(function(sector) { %>
                    <option value="<%= sector.id %>"><%= sector.name %></option>
                  <% }); %>
                </select>
                <div class="form-help">Todos os integrantes do setor selecionado poder√£o visualizar o registro.</div>
              </div>

              <div class="form-group">
                <label for="visibility" class="form-label">Visibilidade</label>
                <select id="visibility" name="visibility" class="form-select" autocomplete="off">
                  <option value="private">Privado (apenas destinat√°rio)</option>
                  <option value="public">P√∫blico (todos com acesso)</option>
                </select>
                <div class="form-help">Registros p√∫blicos ficam vis√≠veis para todos com permiss√£o de leitura.</div>
              </div>
            </fieldset>

            <fieldset style="border: 1px solid var(--border-light); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 2rem;">
              <legend style="padding: 0 0.5rem; font-weight: 600; color: var(--text-primary);">üë§ Dados do Remetente</legend>
              <div class="form-group">
                <label for="sender_name" class="form-label required">Nome do Remetente</label>
                <input id="sender_name" name="sender_name" type="text" class="form-input" placeholder="Nome completo de quem ligou" required data-label="Nome do remetente" autocomplete="name" />
              </div>
              <div class="form-grid-2">
                <div class="form-group">
                  <label for="sender_phone" class="form-label">Telefone</label>
                  <input id="sender_phone" name="sender_phone" type="tel" class="form-input" placeholder="(11) 99999-9999" autocomplete="tel" />
                  <div class="form-help">Telefone para retorno (opcional)</div>
                </div>
                <div class="form-group">
                  <label for="sender_email" class="form-label">E-mail</label>
                  <input id="sender_email" name="sender_email" type="email" class="form-input" placeholder="email@exemplo.com" autocomplete="email" />
                  <div class="form-help">E-mail para contato (opcional)</div>
                </div>
              </div>
              <div class="form-group">
                <label for="callback_at" class="form-label">Data e hor√°rio para retorno</label>
                <input id="callback_at" name="callback_at" type="datetime-local" class="form-input" autocomplete="off" />
                <div class="form-help">Melhor hor√°rio para retornar a liga√ß√£o (opcional)</div>
              </div>
              <input type="hidden" name="parent_message_id" id="parent_message_id" />
              <div class="card related-card" data-related-container data-feature="on" data-limit="5">
                <div class="card-header">
                  <h3 class="card-title">Registros relacionados</h3>
                  <p class="card-subtitle">Visualize registros anteriores deste contato e vincule, se necess√°rio.</p>
                </div>
                <div class="card-body">
                  <p class="text-muted" data-related-feedback>Atualize telefone ou e-mail para verificar registros anteriores.</p>
                  <ul class="related-list" data-related-list hidden></ul>
                </div>
                <div class="card-footer related-card__footer d-none" data-related-footer>
                  <p class="text-muted" data-related-selection hidden>
                    Registro atual vinculado ao hist√≥rico <strong>#<span data-related-selection-id></span></strong>.
                    <button type="button" class="btn btn-link" data-related-clear>Remover v√≠nculo</button>
                  </p>
                  <a class="btn btn-link" data-related-history hidden target="_blank" rel="noopener">Ver hist√≥rico completo</a>
                </div>
              </div>
            </fieldset>

            <fieldset style="border: 1px solid var(--border-light); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 2rem;">
              <legend style="padding: 0 0.5rem; font-weight: 600; color: var(--text-primary);">üìù Conte√∫do do Registro</legend>
              <div class="form-group">
                <label for="subject" class="form-label required">Assunto</label>
                <input id="subject" name="subject" type="text" class="form-input" placeholder="Resumo do motivo da liga√ß√£o" required data-label="Assunto" autocomplete="off" />
                <div class="form-help">Descreva brevemente o motivo da liga√ß√£o</div>
              </div>
              <div class="form-group">
                <label for="notes" class="form-label">Observa√ß√µes</label>
                <textarea id="notes" name="notes" class="form-textarea" rows="4" placeholder="Detalhes adicionais, contexto ou informa√ß√µes importantes sobre o contato..." autocomplete="off"></textarea>
                <div class="form-help">Informa√ß√µes adicionais que possam ser √∫teis (opcional)</div>
              </div>
              <div class="form-group">
                <label for="status" class="form-label">Situa√ß√£o</label>
                <select id="status" name="status" class="form-select" autocomplete="off">
                  <option value="pending">Pendente</option>
                  <option value="in_progress">Em Andamento</option>
                  <option value="resolved">Resolvido</option>
                </select>
                <div class="form-help">Status atual do registro</div>
              </div>
            </fieldset>
          </div>
          <div class="card-footer">
            <div style="display:flex;gap:1rem;justify-content:flex-end;flex-wrap:wrap;">
              <% if (permissions && permissions.deleteMessages) { %>
                <button type="button" class="btn btn-error" id="btnExcluir">üóëÔ∏è Excluir</button>
              <% } %>
              <a id="btnCancelar" href="/recados" class="btn btn-outline">Cancelar</a>
              <button type="submit" class="btn btn-primary" id="btnSalvar">üíæ Salvar</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </main>

  <%- include('partials/footer', { scripts: ['/js/messages-form.js', '/js/editar-recado.js'] }) %>
