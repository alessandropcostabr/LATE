<%- include('partials/header', { title }) %>
<%- include('partials/navbar', { title, user }) %>
<main class="container page">
  <header class="page__header">
    <div>
      <p class="eyebrow">CRM</p>
      <h1>Oportunidades</h1>
      <p class="muted">Visão rápida das oportunidades recentes (máx 100).</p>
    </div>
  </header>

  <section class="card">
    <header class="card__header">
      <h2>Nova oportunidade</h2>
      <p class="muted">Cadastre uma oportunidade com contato e campos customizados.</p>
    </header>
    <div class="card__body">
      <form id="opportunityCreateForm" class="stack">
        <div class="grid">
          <div data-field-key="title">
            <label class="form-label">Título</label>
            <input name="title" class="input" required>
          </div>
          <div data-field-key="contact_name">
            <label class="form-label">Nome do contato</label>
            <input name="contact_name" class="input">
          </div>
          <div data-field-key="contact_email">
            <label class="form-label">E-mail do contato</label>
            <input name="contact_email" type="email" class="input">
          </div>
          <div data-field-key="contact_phone">
            <label class="form-label">Telefone do contato</label>
            <input name="contact_phone" class="input">
          </div>
          <div data-field-key="pipeline_id">
            <label class="form-label">Pipeline</label>
            <select name="pipeline_id" class="input" id="oppPipelineSelect" required>
              <option value="">Selecionar pipeline</option>
              <% (pipelines || []).forEach((p) => { %>
                <option value="<%= p.id %>"><%= p.name %></option>
              <% }); %>
            </select>
          </div>
          <div data-field-key="stage_id">
            <label class="form-label">Estágio</label>
            <select name="stage_id" class="input" id="oppStageSelect" required>
              <option value="">Selecionar estágio</option>
            </select>
          </div>
          <div data-field-key="amount">
            <label class="form-label">Valor</label>
            <input name="amount" type="number" class="input" min="0">
          </div>
          <div data-field-key="close_date">
            <label class="form-label">Fechamento</label>
            <input name="close_date" type="date" class="input">
          </div>
          <div data-field-key="source">
            <label class="form-label">Fonte</label>
            <input name="source" class="input" placeholder="desconhecida">
          </div>
          <div data-field-key="description" style="grid-column:1 / -1;">
            <label class="form-label">Descrição</label>
            <textarea name="description" class="input" rows="2"></textarea>
          </div>
        </div>
        <div style="margin-top:0.5rem;">
          <h3 class="muted" style="margin:0 0 0.5rem;">Campos customizados</h3>
          <%- include('partials/custom-fields-form', { fields: customFields || [], values: {} }) %>
          <div class="form-error" id="oppStageRequiredAlert" hidden></div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Salvar oportunidade</button>
        </div>
      </form>
    </div>
  </section>

  <section class="card">
    <div class="card-body">
      <form id="opportunityFilters" class="filters-grid" style="margin-bottom:1rem;">
        <div class="form-group">
          <label for="search" class="form-label">Buscar</label>
          <input id="search" name="search" type="text" class="form-input" placeholder="Título ou contato">
        </div>
        <%- include('partials/scope-filter', { scope: scope || 'me', id: 'scope' }) %>
        <div class="form-actions" style="align-items:flex-end;">
          <button type="submit" class="btn btn-primary">Aplicar</button>
          <button type="reset" class="btn btn-outline" id="opportunityFiltersReset">Limpar</button>
        </div>
      </form>
    </div>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Título</th>
            <th>Contato</th>
            <th>Telefone</th>
            <th>Pipeline / Estágio</th>
            <th>Valor</th>
            <th>Fechamento</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% if (!opportunities || opportunities.length === 0) { %>
            <tr><td colspan="7" class="muted">Nenhuma oportunidade encontrada.</td></tr>
          <% } else { %>
            <% opportunities.forEach((opp) => { %>
              <tr>
                <td><%= opp.title %></td>
                <td><%= opp.contact_name || '-' %></td>
                <td><%= opp.phone || '-' %></td>
                <td><%= opp.pipeline_id %> / <%= opp.stage_id %></td>
                <td><%= opp.amount ? `R$ ${Number(opp.amount).toFixed(2)}` : '-' %></td>
                <td><%= opp.close_date ? new Date(opp.close_date).toLocaleDateString('pt-BR') : '-' %></td>
                <td><%= opp.source || '-' %></td>
              </tr>
            <% }); %>
          <% } %>
        </tbody>
      </table>
    </div>
  </section>
</main>
<meta name="csrf-token" content="<%= csrfToken %>">
<script>
  window.CRM_OPP_PIPELINES = <%- JSON.stringify(pipelines || []) %>;
  window.CRM_OPP_STAGES = <%- JSON.stringify(stagesByPipeline || {}) %>;
</script>
<%- include('partials/footer', { scripts: ['/js/crm-opportunities.js'] }) %>
