<%- include('partials/header', { title }) %>
<%- include('partials/navbar', { title, user }) %>
<main class="container page">
  <header class="page__header">
    <div>
      <p class="eyebrow">CRM</p>
      <h1>Oportunidades</h1>
      <p class="muted">Visão rápida das oportunidades recentes (máx 100).</p>
    </div>
  </header>

  <section class="card">
    <div class="card-body">
      <form id="opportunityFilters" class="filters-grid" style="margin-bottom:1rem;">
        <div class="form-group">
          <label for="search" class="form-label">Buscar</label>
          <input id="search" name="search" type="text" class="form-input" placeholder="Título ou contato">
        </div>
        <%- include('partials/scope-filter', { scope: scope || 'me', id: 'scope' }) %>
        <div class="form-actions" style="align-items:flex-end;">
          <button type="submit" class="btn btn-primary">Aplicar</button>
          <button type="reset" class="btn btn-outline" id="opportunityFiltersReset">Limpar</button>
        </div>
      </form>
    </div>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Título</th>
            <th>Contato</th>
            <th>Telefone</th>
            <th>Pipeline / Estágio</th>
            <th>Valor</th>
            <th>Fechamento</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% if (!opportunities || opportunities.length === 0) { %>
            <tr><td colspan="7" class="muted">Nenhuma oportunidade encontrada.</td></tr>
          <% } else { %>
            <% opportunities.forEach((opp) => { %>
              <tr>
                <td><%= opp.title %></td>
                <td><%= opp.contact_name || '-' %></td>
                <td><%= opp.phone || '-' %></td>
                <td><%= opp.pipeline_id %> / <%= opp.stage_id %></td>
                <td><%= opp.amount ? `R$ ${Number(opp.amount).toFixed(2)}` : '-' %></td>
                <td><%= opp.close_date ? new Date(opp.close_date).toLocaleDateString('pt-BR') : '-' %></td>
                <td><%= opp.source || '-' %></td>
              </tr>
            <% }); %>
          <% } %>
        </tbody>
      </table>
    </div>
  </section>
</main>
<%- include('partials/footer', { scripts: ['/js/crm-opportunities.js'] }) %>
