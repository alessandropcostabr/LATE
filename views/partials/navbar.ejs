<% const canReadMessages = permissions && permissions.readMessages; %>
<% const canCreateMessages = permissions && permissions.createMessages; %>
<% const showReports =
  typeof userRoleSlug !== 'undefined' &&
  (userRoleSlug === 'admin' || userRoleSlug === 'supervisor'); %>
<% const rawUserName = (typeof user !== 'undefined' && user && user.name) ? String(user.name).trim() : ''; %>
<% const userNameParts = rawUserName ? rawUserName.split(/\s+/).filter(Boolean) : []; %>
<% const displayUserName = userNameParts.length > 1 ? `${userNameParts[0]} ${userNameParts[userNameParts.length - 1]}` : (userNameParts[0] || 'Usuário'); %>

<nav class="app-navbar" role="navigation" aria-label="Navegação principal">
  <div class="container app-navbar__inner">
    <button
      id="appNavbarToggle"
      class="app-navbar__toggle"
      type="button"
      aria-label="Abrir menu"
      aria-expanded="false"
      aria-controls="appNavbarMenu">
      <span class="app-navbar__toggle-icon" aria-hidden="true"></span>
    </button>

    <a class="app-navbar__brand" href="/">
      <img src="/assets/logo.png" alt="LATE" height="44">
    </a>

    <div class="app-navbar__actions">
      <a href="/news" class="app-navbar__link<%= title === 'Novidades' ? ' is-active' : '' %>">Novidades</a>

      <% if (typeof user !== 'undefined' && user) { %>
        <div class="app-navbar__user">
          <button
            id="appNavbarUserToggle"
            class="app-navbar__user-toggle"
            type="button"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="appNavbarUserMenu">
            <span class="app-navbar__avatar" aria-hidden="true">
            <%= (user.name || user.email || '?').trim().charAt(0).toUpperCase() %>
            </span>
            <span class="app-navbar__user-name"><%= displayUserName %></span>
            <span class="app-navbar__caret" aria-hidden="true"></span>
          </button>
          <div class="app-navbar__user-menu" id="appNavbarUserMenu" role="menu" aria-hidden="true">
            <a href="/manual-operacional" class="app-navbar__user-item" role="menuitem">Manual Operacional</a>
            <a href="/account/password" class="app-navbar__user-item" role="menuitem">Trocar senha</a>
            <a href="/logout" class="app-navbar__user-item" role="menuitem">Sair</a>
          </div>
        </div>
      <% } %>

      <a href="/help" class="btn btn-outline app-navbar__help<%= title && title.includes('Ajuda') ? ' is-active' : '' %>">Ajuda</a>
    </div>
  </div>

  <div class="app-navbar__menu" id="appNavbarMenu">
    <ul class="app-navbar__menu-list">
      <li><a href="/" class="app-navbar__menu-link<%= title === 'Dashboard' ? ' is-active' : '' %>">Dashboard</a></li>

      <% if (canReadMessages) { %>
        <li><a href="/recados" class="app-navbar__menu-link<%= title === 'Registros' ? ' is-active' : '' %>">Registros</a></li>
        <li><a href="/recados/kanban" class="app-navbar__menu-link<%= title === 'Registros · Kanban' ? ' is-active' : '' %>">Kanban</a></li>
        <li><a href="/recados/calendario" class="app-navbar__menu-link<%= title === 'Registros · Calendário' ? ' is-active' : '' %>">Calendário</a></li>
      <% } %>

      <% if (canCreateMessages) { %>
        <li><a href="/novo-recado" class="app-navbar__menu-link<%= title === 'Novo Registro' ? ' is-active' : '' %>">Novo Registro</a></li>
      <% } %>

      <% if (showReports) { %>
        <li><a href="/relatorios" class="app-navbar__menu-link<%= title === 'Relatórios' ? ' is-active' : '' %>">Relatórios</a></li>
      <% } %>

      <% if (userRoleSlug === 'admin') { %>
        <li class="app-navbar__menu-group">
          <span class="app-navbar__menu-group-label">Admin</span>
          <ul>
            <li><a href="/admin/usuarios" class="app-navbar__menu-link<%= title === 'Admin · Usuários' ? ' is-active' : '' %>">Usuários</a></li>
            <li><a href="/admin/setores" class="app-navbar__menu-link<%= title === 'Admin · Setores' ? ' is-active' : '' %>">Setores</a></li>
            <li><a href="/admin/notificacoes" class="app-navbar__menu-link<%= title === 'Configurações de Notificações' ? ' is-active' : '' %>">Notificações</a></li>
          </ul>
        </li>
      <% } %>

      <% if (!user) { %>
        <li><a href="/login" class="app-navbar__menu-link<%= title === 'Login' ? ' is-active' : '' %>">Login</a></li>
      <% } %>
    </ul>
  </div>
</nav>
