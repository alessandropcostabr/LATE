<% const perms = typeof permissions === 'object' && permissions !== null ? permissions : {}; %>
<% const canReadMessages = Boolean(perms.readMessages); %>
<% const canCreateMessages = Boolean(perms.createMessages); %>
<% const roleSlug = typeof userRoleSlug === 'string' ? userRoleSlug : ''; %>
<% const showReports = roleSlug === 'admin' || roleSlug === 'supervisor'; %>
<% const rawUserName = (typeof user !== 'undefined' && user && user.name) ? String(user.name).trim() : ''; %>
<% const userNameParts = rawUserName ? rawUserName.split(/\s+/).filter(Boolean) : []; %>
<% const displayUserName = userNameParts.length > 1 ? `${userNameParts[0]} ${userNameParts[userNameParts.length - 1]}` : (userNameParts[0] || 'Usuário'); %>

<nav class="app-navbar" role="navigation" aria-label="Navegação principal">
  <div class="container app-navbar__inner">
    <button
      id="appNavbarToggle"
      class="app-navbar__toggle"
      type="button"
      aria-label="Abrir menu"
      aria-expanded="false"
      aria-controls="appNavbarMenu">
      <span class="app-navbar__toggle-icon" aria-hidden="true"></span>
    </button>

    <a class="app-navbar__brand" href="/">
      <img src="/assets/logo.png" alt="LATE" height="44">
    </a>

    <div class="app-navbar__actions">
      <% if (typeof user !== 'undefined' && user) { %>
        <a href="/news" class="app-navbar__link<%= title === 'Novidades' ? ' is-active' : '' %>">Novidades</a>

        <div class="app-navbar__user">
          <button
            id="appNavbarUserToggle"
            class="app-navbar__user-toggle"
            type="button"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="appNavbarUserMenu">
            <span class="app-navbar__avatar" aria-hidden="true">
            <%= (user.name || user.email || '?').trim().charAt(0).toUpperCase() %>
            </span>
            <span class="app-navbar__user-name"><%= displayUserName %></span>
            <span class="app-navbar__caret" aria-hidden="true"></span>
          </button>
          <div class="app-navbar__user-menu" id="appNavbarUserMenu" role="menu" aria-hidden="true">
            <a href="/manual-operacional" class="app-navbar__user-item" role="menuitem">Manual Operacional</a>
            <a href="/roadmap" class="app-navbar__user-item" role="menuitem">Plano de evolução</a>
            <a href="/help" class="app-navbar__user-item" role="menuitem">Central de ajuda</a>
            <a href="/account/password" class="app-navbar__user-item" role="menuitem">Trocar senha</a>
            <a href="/logout" class="app-navbar__user-item" role="menuitem">Sair</a>
          </div>
        </div>
      <% } else { %>
        <a href="/news" class="app-navbar__link<%= title === 'Novidades' ? ' is-active' : '' %>">Novidades</a>
        <a href="/help" class="btn btn-outline app-navbar__help<%= title && title.includes('Ajuda') ? ' is-active' : '' %>">Ajuda</a>
      <% } %>
    </div>
  </div>

  <div class="app-navbar__menu" id="appNavbarMenu">
    <% const iconMap = {
      dashboard: '/assets/icon-painel_controle.svg',
      records: '/assets/icon-registros.svg',
      reports: '/assets/icon-relatorios.svg',
      admin: '/assets/icon-administracao.svg',
      support: '/assets/icon-suporte.svg'
    }; %>
    <% const navSections = []; %>
    <% navSections.push({
      key: 'dashboard',
      label: 'Painel de controle',
        icon: iconMap.dashboard,
      defaultOpen: true,
      items: [
        { label: 'Dashboard', href: '/', active: title === 'Dashboard' }
      ]
    }); %>

    <% if (canReadMessages || canCreateMessages) { %>
      <% const registroItems = []; %>
      <% if (canReadMessages) { %>
        <% registroItems.push(
          { label: 'Recados', href: '/recados', active: title === 'Recados' },
          { label: 'Kanban', href: '/recados/kanban', active: title === 'Registros · Kanban' },
          { label: 'Calendário', href: '/recados/calendario', active: title === 'Registros · Calendário' }
        ); %>
      <% } %>
      <% if (canCreateMessages) { registroItems.push({ label: 'Novo Recado', href: '/novo-recado', active: title === 'Novo Recado' }); } %>
      <% if (registroItems.length) { navSections.push({ key: 'records', label: 'Registros', icon: iconMap.records, items: registroItems, defaultOpen: true }); } %>
    <% } %>

    <% if (user) { %>
      <% navSections.push({
        key: 'crm',
        label: 'CRM',
        icon: iconMap.records,
        defaultOpen: false,
        items: [
          { label: 'Dashboard', href: '/crm/dashboard', active: title === 'CRM · Dashboard' },
          { label: 'Pipelines (API)', href: '/api/crm/pipelines', active: false, external: true },
          { label: 'Leads', href: '/crm/leads', active: title === 'CRM · Leads' },
          { label: 'Oportunidades', href: '/crm/oportunidades', active: title === 'CRM · Oportunidades' },
        ]
      }); %>
    <% } %>

    <% if (showReports) { %>
      <% navSections.push({
        key: 'reports',
        label: 'Relatórios',
        icon: iconMap.reports,
        items: [
          { label: 'Estatísticas', href: '/relatorios/estatisticas', active: title && title.includes('Relatórios · Estatísticas') },
          { label: 'Auditoria', href: '/relatorios/auditoria', active: title && title.includes('Relatórios · Auditoria') },
          { label: 'Exportações', href: '/relatorios/exportacoes', active: title && title.includes('Relatórios · Exportações') },
          { label: 'Status Operacional', href: '/relatorios/status', active: title && title.includes('Relatórios · Status Operacional') }
        ]
      }); %>
    <% } %>

    <% if (roleSlug === 'admin') { %>
      <% navSections.push({
        key: 'admin',
        label: 'Administração',
        icon: iconMap.admin,
        items: [
          { label: 'Usuários', href: '/admin/usuarios', active: title === 'Admin · Usuários' },
          { label: 'Setores', href: '/admin/setores', active: title === 'Admin · Setores' },
          { label: 'Notificações', href: '/admin/notificacoes', active: title === 'Configurações de Notificações' }
        ]
      }); %>
    <% } %>

    <% if (user) { %>
      <% navSections.push({
        key: 'support',
        label: 'Suporte & Docs',
        icon: iconMap.support,
        defaultOpen: false,
        items: [
          { label: 'Novidades', href: '/news', active: title === 'Novidades' },
          { label: 'Manual Operacional', href: '/manual-operacional', active: title === 'Manual Operacional' },
          { label: 'Plano de evolução', href: '/roadmap', active: title === 'Roadmap' },
          { label: 'Central de ajuda', href: '/help', active: title === 'Central de Ajuda' }
        ]
      }); %>
    <% } %>

    <ul class="app-navbar__menu-list">
      <% navSections.forEach((section, index) => {
        const hasItems = Array.isArray(section.items) && section.items.length;
        if (!hasItems) { return; }
        const sectionId = `navSection${index}`;
        const isOpen = section.defaultOpen !== false;
      %>
        <li class="app-navbar__menu-section<%= isOpen ? ' is-open' : '' %>">
          <button
            class="app-navbar__section-toggle"
            type="button"
            data-target="#<%= sectionId %>"
            aria-expanded="<%= isOpen ? 'true' : 'false' %>">
            <span class="app-navbar__section-icon" aria-hidden="true">
              <% if (section.icon) { %>
                <img src="<%= section.icon %>" alt="" role="presentation" />
              <% } %>
            </span>
            <span class="app-navbar__section-title"><%= section.label %></span>
            <span class="app-navbar__section-caret" aria-hidden="true"></span>
          </button>
          <ul
            class="app-navbar__section-list"
            id="<%= sectionId %>"
            <%= isOpen ? '' : 'hidden' %>
            aria-hidden="<%= isOpen ? 'false' : 'true' %>">
            <% section.items.forEach((item) => { %>
              <li>
                <% if (item.disabled) { %>
                  <span class="app-navbar__section-link is-disabled" aria-disabled="true"><%= item.label %></span>
                <% } else { %>
                  <a href="<%= item.href %>" class="app-navbar__section-link<%= item.active ? ' is-active' : '' %>"><%= item.label %></a>
                <% } %>
              </li>
            <% }); %>
          </ul>
        </li>
      <% }); %>

      <% if (!user) { %>
        <li class="app-navbar__menu-section is-open">
          <div class="app-navbar__section-list" aria-hidden="false">
            <a href="/login" class="app-navbar__section-link<%= title === 'Login' ? ' is-active' : '' %>">Login</a>
            <a href="/help" class="app-navbar__section-link<%= title && title.includes('Ajuda') ? ' is-active' : '' %>">Central de ajuda</a>
          </div>
        </li>
      <% } %>
    </ul>
  </div>
</nav>
