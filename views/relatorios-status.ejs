<%- include('partials/header') %>
<body>
  <%- include('partials/navbar') %>

  <main class="main" role="main">
    <div class="container">
      <h1>Relatórios · Status Operacional</h1>
      <p id="status-last-updated" class="muted">Sincronizando...</p>

      <%
        const currentScope = accessScope || 'unrestricted';
        const scopeLabels = {
          unrestricted: 'Acesso liberado',
          ip_restrito: 'Restrito por IP',
          ip_restricted: 'Restrito por IP',
          schedule_restricted: 'Restrito por horário',
          blocked: 'Bloqueado',
        };
        const scopeClasses = {
          unrestricted: 'badge bg-success',
          ip_restrito: 'badge bg-warning',
          ip_restricted: 'badge bg-warning',
          schedule_restricted: 'badge bg-warning',
          blocked: 'badge bg-danger',
        };
        const scopeLabel = scopeLabels[currentScope] || 'Acesso monitorado';
        const scopeClass = scopeClasses[currentScope] || 'badge bg-secondary';
        const restrictions = accessRestrictions || {};
        const restrictionTags = [];
        if (restrictions.ip?.enabled) restrictionTags.push('IP restrito');
        if (restrictions.schedule?.enabled) restrictionTags.push('Horário restrito');
      %>
      <div class="card" style="margin-bottom:1.5rem;">
        <div class="card-header">
          <h2 class="card-title">Sessão &amp; Rede</h2>
        </div>
        <div class="card-body">
          <ul class="status-list">
            <li>Seu IP atual: <strong id="session-client-ip"><%= clientIp || 'Indisponível' %></strong></li>
            <li>
              Tipo de sessão:
              <span id="session-access-scope" class="<%= scopeClass %>"><%= scopeLabel %></span>
            </li>
            <li>
              Restrições ativas:
              <% if (!restrictionTags.length) { %>
                <span class="text-muted">Nenhuma</span>
              <% } else { %>
                <%= restrictionTags.join(' · ') %>
              <% } %>
            </li>
            <% if (restrictions.ip?.enabled) { %>
              <li>
                IPs permitidos:
                <% if (Array.isArray(restrictions.ip.allowed) && restrictions.ip.allowed.length) { %>
                  <%= restrictions.ip.allowed.join(', ') %>
                <% } else { %>
                  <span class="text-muted">Nenhum IP configurado</span>
                <% } %>
              </li>
            <% } %>
            <% if (restrictions.schedule?.enabled) { %>
              <li>
                Horários permitidos:
                <ul class="mt-2 mb-0">
                  <% (restrictions.schedule.ranges || []).forEach(function(range) { %>
                    <li class="text-muted">
                      <strong><%= range.day.toUpperCase() %></strong> · <%= range.start %> — <%= range.end %>
                    </li>
                  <% }) %>
                </ul>
              </li>
            <% } %>
          </ul>
        </div>
      </div>

      <div class="card" style="margin-bottom:1.5rem;">
        <div class="card-header">
          <h2 class="card-title">Aplicação</h2>
        </div>
        <div class="card-body">
          <ul class="status-list">
            <li>Versão: <strong id="app-version">-</strong></li>
            <li>Build: <strong id="app-build">-</strong></li>
            <li>Node.js: <strong id="app-node">-</strong></li>
            <li>Ambiente: <strong id="app-env">-</strong></li>
            <li>Hostname: <strong id="app-hostname">-</strong></li>
            <li>Uptime: <strong id="app-uptime">-</strong></li>
            <li>Memória RSS: <strong id="app-memory">-</strong></li>
          </ul>
        </div>
      </div>

      <div class="card" style="margin-bottom:1.5rem;">
        <div class="card-header">
          <h2 class="card-title">PostgreSQL</h2>
        </div>
        <div class="card-body">
          <p id="db-status" class="status-indicator">Coletando...</p>
          <ul class="status-list">
            <li>Latência SELECT 1: <strong id="db-latency">-</strong></li>
            <li>Papel: <strong id="db-role">-</strong></li>
          </ul>
          <div id="db-replication-extra" class="status-extra"></div>
        </div>
      </div>

      <div class="card" style="margin-bottom:1.5rem;">
        <div class="card-header">
          <h2 class="card-title">Serviços Externos</h2>
        </div>
        <div class="card-body">
          <ul class="status-list">
            <li>
              VIP Health:
              <span id="vip-health-status" class="status-indicator">-</span>
            </li>
            <li>
              Tunnel Cloudflare:
              <span id="tunnel-health-status" class="status-indicator">-</span>
            </li>
          </ul>
        </div>
      </div>

      <div class="card" style="margin-bottom:1.5rem;">
        <div class="card-header">
          <h2 class="card-title">Fila de Exportações</h2>
        </div>
        <div class="card-body">
          <ul class="status-list">
            <li>Pendentes: <strong id="exports-pending">-</strong></li>
            <li>Processando: <strong id="exports-processing">-</strong></li>
            <li>Falhas: <strong id="exports-failed">-</strong></li>
            <li>Travados (&gt;15min): <strong id="exports-stalled">-</strong></li>
            <li>Última falha: <strong id="exports-last-failed">-</strong></li>
            <li>Última conclusão: <strong id="exports-last-completed">-</strong></li>
          </ul>
        </div>
      </div>

      <div class="card" style="margin-bottom:1.5rem;" id="prometheus-card">
        <div class="card-header">
          <h2 class="card-title">Resumo Prometheus por Nó</h2>
        </div>
        <div class="card-body">
          <div id="prometheus-disabled" class="muted" hidden>Sem dados Prometheus.</div>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th scope="col">Instance</th>
                  <th scope="col">UP</th>
                  <th scope="col">Load1</th>
                  <th scope="col">CPU %</th>
                  <th scope="col">Mem %</th>
                  <th scope="col">RootFS %</th>
                  <th scope="col">RX (B/s)</th>
                  <th scope="col">TX (B/s)</th>
                </tr>
              </thead>
              <tbody id="prometheus-node-rows">
                <tr>
                  <td colspan="8" class="muted">Aguardando atualização...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer', { scripts: scripts || [] }) %>
</body>
</html>
