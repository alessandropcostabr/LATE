---
- name: Garantir que o repositório existe
  stat:
    path: "{{ app_root }}/.git"
  register: repo_stat

- name: Abort if repo missing
  fail:
    msg: "Repositório não encontrado em {{ app_root }}"
  when: not repo_stat.stat.exists

- name: Atualizar repositório para {{ repo_branch }}
  command: git pull --ff-only origin {{ repo_branch }}
  args:
    chdir: "{{ app_root }}"
  register: git_pull
  changed_when: "'Already up to date' not in git_pull.stdout"
  when: not ansible_check_mode

- name: Instalar dependências npm
  command: "{{ npm_bin }} install"
  args:
    chdir: "{{ app_root }}"
  when:
    - (npm_install | default(true)) | bool
    - not ansible_check_mode

- name: Reload PM2 ecosystem
  command: "{{ pm2_bin }} reload {{ pm2_ecosystem }}"
  args:
    chdir: "{{ app_root }}"
  when: not ansible_check_mode

- name: Recriar processo web em cluster (garantia)
  command: "{{ pm2_bin }} start {{ pm2_ecosystem }} --only {{ pm2_web_process }} --update-env"
  args:
    chdir: "{{ app_root }}"
  when: not ansible_check_mode

- name: Garantir workers online
  loop: "{{ pm2_extra_processes }}"
  command: "{{ pm2_bin }} start {{ pm2_ecosystem }} --only {{ item }} --update-env"
  args:
    chdir: "{{ app_root }}"
  when: not ansible_check_mode
